---
layout: mypost
title:  "D3D11 æ¸²æŸ“ç®¡çº¿"
date:   2023-08-26 10:13:17 +0800
categories: graphics
location: HangZhou,China
---
---

### é¡¶ç‚¹ç€è‰²å™¨ä¸­çš„åæ ‡

é¡¶ç‚¹é»˜è®¤ä½¿ç”¨Normalized Device Coordinatesã€‚
å½“ä½ æŠŠä¸€ä¸ªé¡¶ç‚¹ä¼ è¿›é¡¶ç‚¹ç€è‰²å™¨åï¼Œæœ€ç»ˆè¾“å‡ºä¸€ä¸ª SV_POSITIONï¼Œè¿™ä¸ªä½ç½®è¢«æŠ•å½±åˆ°äº† NDC ç©ºé—´ï¼ˆå½’ä¸€åŒ–è®¾å¤‡åæ ‡ï¼‰ï¼Œå®ƒå…·æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š

| è½´å‘ | èŒƒå›´     | å«ä¹‰                     |
| ---- | -------- | ------------------------ |
| X    | -1 åˆ° +1 | å·¦åˆ°å³                   |
| Y    | +1 åˆ° -1 | ä¸Šåˆ°ä¸‹ï¼ˆæ³¨æ„æ˜¯**å€’çš„**ï¼‰ |
| Z    | 0 åˆ° +1  | å‰åˆ°åï¼ˆè§†é”¥å†…çš„æ·±åº¦ï¼‰   |

ğŸ¤“ D3D11 çš„ç‰¹æ®Šç‚¹:
* å·¦æ‰‹åæ ‡ç³»ï¼šD3D é»˜è®¤ä½¿ç”¨å·¦æ‰‹åæ ‡ç³»ï¼ˆxå³ï¼Œyä¸Šï¼Œzå‘å±å¹•å†…ï¼‰
* NDC çš„ Z èŒƒå›´æ˜¯ 0 åˆ° 1ï¼ˆOpenGL æ˜¯ -1 åˆ° +1ï¼‰


### Primitives(å›¾å…ƒ)

* Point Lists
* Line Lists
* Line Strips
* Triangle Lists (æœ€å¸¸ç”¨)
* Triangle Strips

### æ¸²æŸ“ç®¡çº¿

```text
è¾“å…¥è£…é…ï¼ˆIAï¼‰ â†’ é¡¶ç‚¹ç€è‰²å™¨ï¼ˆVSï¼‰ â†’ æ›²é¢ç»†åˆ†é˜¶æ®µï¼ˆHS/DSï¼‰ â†’ å‡ ä½•ç€è‰²å™¨ï¼ˆGSï¼‰
        â†“
å…‰æ …åŒ–ï¼ˆRasterizerï¼‰
        â†“
åƒç´ ç€è‰²å™¨ï¼ˆPSï¼‰
        â†“
è¾“å‡ºåˆå¹¶ï¼ˆOMï¼‰
```

| é˜¶æ®µ       | å¯ç¼–ç¨‹ï¼Ÿ | Shader åç§°        | æ˜¯å¦å¿…é¡» |
| ---------- | -------- | ------------------ | -------- |
| IA         | âŒ        | æ—                  | æ˜¯       |
| VS         | âœ…        | Vertex Shader      | âœ… å¿…é¡»   |
| HS/DS      | âœ…        | Hull/Domain Shader | å¯é€‰     |
| GS         | âœ…        | Geometry Shader    | å¯é€‰     |
| Rasterizer | âŒ        | æ—                  | æ˜¯       |
| PS         | âœ…        | Pixel Shader       | âœ… å¿…é¡»   |
| OM         | âŒ        | æ—                  | æ˜¯       |



## çº¹ç†

### DXGI FORMATå¯¹åº”HLSLä¸­çš„ç±»å‹
| DXGI                           | HLSL         |
| ------------------------------ | ------------ |
| DXGI_FORMAT_R32_FLOAT          | float        |
| DXGI_FORMAT_R32G32_FLOAT       | float2       |
| DXGI_FORMAT_R32G32B32A32_FLOAT | float4       |
| DXGI_FORMAT_R32_UINT           | uint         |
| DXGI_FORMAT_R32G32_UINT        | uint2        |
| DXGI_FORMAT_R32G32B32A32_UINT  | uint4        |
| DXGI_FORMAT_R32_SINT           | int          |
| DXGI_FORMAT_R32G32_SINT        | int2         |
| DXGI_FORMAT_R32G32B32A32_SINT  | int4         |
| DXGI_FORMAT_R16G16B16A16_FLOAT | float4       |
| DXGI_FORMAT_R8G8B8A8_UNORM     | unorm float4 |
| DXGI_FORMAT_R8G8B8A8_SNORM     | snorm float4 |

å…¶ä¸­unorm floatè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ª32ä½æ— ç¬¦å·çš„ï¼Œè§„æ ¼åŒ–çš„æµ®ç‚¹æ•°ï¼Œå¯ä»¥è¡¨ç¤ºèŒƒå›´0åˆ°1
è€Œä¸ä¹‹å¯¹åº”çš„snorm floatè¡¨ç¤ºçš„æ˜¯32ä½æœ‰ç¬¦å·çš„ï¼Œè§„æ ¼åŒ–çš„æµ®ç‚¹æ•°ï¼Œå¯ä»¥è¡¨ç¤ºèŒƒå›´-1åˆ°1

### USAGE
| D3D11_USAGE           | CPUè¯» | CPUå†™ | GPUè¯» | GPUå†™ |
| --------------------- | ----- | ----- | ----- | ----- |
| D3D11_USAGE_DEFAULT   |       |       | âˆš     | âˆš     |
| D3D11_USAGE_IMMUTABLE | âˆš     |       |       |       |
| D3D11_USAGE_DYNAMIC   |       | âˆš     | âˆš     |       |
| D3D11_USAGE_STAGING   | âˆš     | âˆš     | âˆš     | âˆš     |

### BindFlag
| D3D11_BIND_FLAG             | æè¿°                                                        |
| --------------------------- | ----------------------------------------------------------- |
| D3D11_BIND_SHADER_RESOURCE  | çº¹ç†å¯ä»¥ä½œä¸ºç€è‰²å™¨èµ„æºç»‘å®šåˆ°æ¸²æŸ“ç®¡çº¿                        |
| D3D11_BIND_STREAM_OUTPUT    | çº¹ç†å¯ä»¥ä½œä¸ºæµè¾“å‡ºé˜¶æ®µçš„è¾“å‡ºç‚¹                              |
| D3D11_BIND_RENDER_TARGET    | çº¹ç†å¯ä»¥ä½œä¸ºæ¸²æŸ“ç›®æ ‡çš„è¾“å‡ºç‚¹ï¼Œå¹¶ä¸”æŒ‡å®šå®ƒå¯ä»¥ç”¨äºç”Ÿæˆmipmaps |
| D3D11_BIND_DEPTH_STENCIL    | çº¹ç†å¯ä»¥ä½œä¸ºæ·±åº¦/æ¨¡æ¿ç¼“å†²åŒº                                 |
| D3D11_BIND_UNORDERED_ACCESS | çº¹ç†å¯ä»¥ç»‘å®šåˆ°æ— åºè®¿é—®è§†å›¾ä½œä¸ºè¾“å‡º                          |

### CPU ACESS

| D3D11_CPU_ACCESS_FLAG  | æè¿°                                                                                                          |
| ---------------------- | ------------------------------------------------------------------------------------------------------------- |
| D3D11_CPU_ACCESS_WRITE | å…è®¸é€šè¿‡æ˜ å°„æ–¹å¼ä»CPUå†™å…¥ï¼Œå®ƒä¸èƒ½ä½œä¸ºç®¡çº¿çš„è¾“å‡ºï¼Œä¸”åªèƒ½ç”¨äºD3D11_USAGE_DYNAMICå’ŒD3D11_USAGE_STAGINGç»‘å®šçš„èµ„æº |
| D3D11_CPU_ACCESS_READ  | å…è®¸é€šè¿‡æ˜ å°„æ–¹å¼ç»™CPUè¯»å–ï¼Œå®ƒä¸èƒ½ä½œä¸ºç®¡çº¿çš„è¾“å…¥æˆ–è¾“å‡ºï¼Œä¸”åªèƒ½ç”¨äºD3D11_USAGE_STAGINGç»‘å®šçš„èµ„æº                |

### Vertex Shadler

```C++
D3D11_INPUT_ELEMENT_DESC input_desc[] =
{
    // æˆ‘ä»¬çŸ¥é“DXGI_FORMAT_R32G32B32_FLOATæ˜¯12å­—èŠ‚çš„
    {"POSITION", 0, DXGI_FORMAT_R32G32B32_FLOAT, 0, 0,  D3D11_INPUT_PER_VERTEX_DATA, 0},
    {"COLOR",    0, DXGI_FORMAT_R32G32B32_FLOAT, 0, 12, D3D11_INPUT_PER_VERTEX_DATA, 0},
};
CreateInputLayout(VERTEX::input_desc, std::size(VERTEX::input_desc), ...);
```
å½“æˆ‘ä»¬åœ¨C++é‡Œé¢å†™å…¥ä¸Šè¿°ä»£ç çš„æ—¶å€™, æ˜¯å‘Šè¯‰D3D11å·²"Position"å’Œ"Color"è§£æè¾“å…¥çš„Vertexæ•°æ®ã€‚

äºæ˜¯, æˆ‘ä»¬å°†ä¸‹é¢çš„æ•°æ®ä¼ ç»™D3D11:

```C++
VERTEX OurVertices[] = {
    // æ¯ç»„æ•°æ®3 * 4 + 3 * 4 = 24å­—èŠ‚
    {DirectX::XMFLOAT3{0.0f, 0.5f, 0.0f}, DirectX::XMFLOAT3(1.0f, 0.0f, 0.0f)},
    {DirectX::XMFLOAT3{0.45f, -0.5, 0.0f}, DirectX::XMFLOAT3(0.0f, 1.0f, 0.0f)},
    {DirectX::XMFLOAT3{-0.45f, -0.5f, 0.0f}, DirectX::XMFLOAT3(0.0f, 0.0f, 1.0f)},
};
CreateBuffer(&vertex_buf_);
IASetVertexBuffers(vertex_buf_);
```

å…³é”®å­—è¯­ä¹‰

| Semantic    | Description                                                                                                                    |
| ----------- | ------------------------------------------------------------------------------------------------------------------------------ |
| POSITION    | A float4 value that stores position. It is used to denote the position of vertices, usually (but not necessarily) in 3D space. |
| COLOR       | A float4 value that stored color                                                                                               |
| SV_POSITION | A float4 value that stores position. It is used to denote the position in normalized screen coordinates, not 3D coordinates.   |
| SV_TARGET   | A float4 value telling the output-merger to draw the given color on the render target.                                         |



```hlsl
// ä¸ºä»€ä¹ˆæ˜¯float4, è€Œä¸æ˜¯float3ï¼Ÿæä¸æ‡‚
// å®æµ‹float3ä¹Ÿå¯ä»¥work
struct VOut {
    float4 position : SV_POSITION;
    float4 color : COLOR;
};


VOut VShader(float4 position : POSITION, float4 color : COLOR)
{
    VOut output;
    output.position = position;
    output.color = color;
    return output;
}

// ä½¿ç”¨çš„æ˜¯normailizedåæ ‡, è¿”å›å€¼æ˜¯ç»™è¾“å‡ºåˆå¹¶é˜¶æ®µçš„ç”¨çš„, è¾“å‡ºåˆ°render Targetä¸Š
float4 PShader(float4 position : SV_POSITION,
    float4 color: COLOR): SV_TARGET
{
    return color;
}
```
### ä¸ºä»€ä¹ˆCPUä¸­çš„float3ä¹Ÿèƒ½åŒ¹é…ä¸ŠVertexShaderä¸­çš„POSITION(float4)è¯­ä¹‰
ğŸ§  çœŸç›¸æ˜¯:

âœ… å¦‚æœä½  VS ä¸­å†™ float4ï¼Œä½† InputLayout æä¾›çš„æ˜¯ float3ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨è¡¥ w=1.0f

è¿™æ˜¯ HLSL é‡Œçš„ä¸€ä¸ªæ™ºèƒ½è§„åˆ™:
>  å¦‚æœä½ çš„ InputLayout æ˜¯ float3ï¼Œè€Œä½ çš„ shader è¦æ±‚ float4ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¡¥æˆ float4(x, y, z, 1.0f)

è¿™ä¸ªè¡Œä¸ºå®Œå…¨åˆæ³•ï¼Œä¸”å¹¿æ³›ä½¿ç”¨ â€”â€” å› ä¸ºé€šå¸¸ä½ éœ€è¦ w=1.0f æ¥åšå˜æ¢çŸ©é˜µä¹˜æ³•ã€‚

âœ… åè¿‡æ¥å°±ä¸è¡Œï¼

å¦‚æœä½ ä¸Šä¼ çš„æ˜¯ float4ï¼Œä½† shader è¾“å…¥å†™çš„æ˜¯ float3ï¼Œä¼šæŠ¥é”™æˆ–è¡Œä¸ºä¸ç¡®å®šã€‚å› ä¸ºä½ ä¼ çš„æ•°æ®æ¯” shader æƒ³è¦çš„è¿˜å¤šï¼ŒHLSL ä¸çŸ¥é“è¦ä¸è¦å¿½ç•¥ã€å‰ªæ‰ï¼Œå®¹æ˜“å‡ºé”™ã€‚

### ä¸ºä»€ä¹ˆVertexShaderçš„è¾“å‡ºå¿…é¡» float4ï¼Ÿ

* GPU ä½¿ç”¨çš„æ˜¯â€œé½æ¬¡åæ ‡ï¼ˆHomogeneous Coordinatesï¼‰â€
* è£å‰ªã€é€è§†é™¤æ³•ã€å±å¹•æ˜ å°„éƒ½ä¾èµ–å®ƒ
* è¿™å°±æ˜¯ä½ è¦æ‰§è¡Œ output.pos = mul(MVP, float4(input.pos, 1.0f)); çš„åŸå› 

### ç¼“å†²åŒºå¯„å­˜å™¨æ ‡è®°

| HLSL register | ç±»å‹                 | æ„ä¹‰                            |
| ------------- | -------------------- | ------------------------------- |
| `b#`          | **å¸¸é‡ç¼“å†²åŒº (CB)**  | Constant Bufferï¼Œæœ€å¤šç»‘å®š 14 ä¸ª |
| `t#`          | **çº¹ç† (Texture)**   | `Texture2D`, `Texture3D`, ç­‰    |
| `s#`          | **é‡‡æ ·å™¨ (Sampler)** | `SamplerState` ç­‰               |
| `u#`          | **æ— åºè®¿é—® (UAV)**   | ç”¨äºè®¡ç®—ç€è‰²å™¨ã€RWç»“æ„ç­‰        |


### HLSL ç»“æ„å¯¹é½çš„é—®é¢˜

ä¸‹é¢æ˜¯å¸¸é‡ç¼“å†²åŒºçš„å¯¹é½è§„åˆ™, ä½†æ˜¯é¡¶ç‚¹ç¼“å†²åŒºçš„å¯¹é½è§„åˆ™åˆæ˜¯å’‹æ ·çš„, ä¸ºä»€ä¹ˆå¤§å®¶éƒ½æ˜¯å†™float4?

see: https://www.cnblogs.com/X-Jun/p/9376474.html


| ç±»å‹                           | æ˜¯å¦éœ€è¦å¯¹é½ | å¸¸è§ç”¨é€”                              |
| ------------------------------ | ------------ | ------------------------------------- |
| `ConstantBuffer`ï¼ˆå¸¸é‡ç¼“å†²åŒºï¼‰ | âœ… å¿…é¡»å¯¹é½   | å‘ Shader ä¼ é€’å‚æ•°ï¼ˆregister(b#)ï¼‰    |
| `StructuredBuffer`             | âœ… å»ºè®®å¯¹é½   | Shader ä¸­è®¿é—®ç»“æ„åŒ–æ•°æ®               |
| `RawBuffer`ï¼ˆå­—èŠ‚åœ°å€ç¼“å†²ï¼‰    | âŒ ä¸å¼ºåˆ¶     | ç”¨ `ByteAddressBuffer` ç±»å‹æŒ‰å­—èŠ‚è®¿é—® |
| `VertexBuffer`                 | âœ… é€šå¸¸å¯¹é½   | é¡¶ç‚¹è¾“å…¥ç»“æ„ä½“                        |
| `IndexBuffer`                  | âŒ ä¸è¦æ±‚     | ç”¨äºç»˜åˆ¶é¡¶ç‚¹é¡ºåºï¼ˆ16æˆ–32bitï¼‰         |
| `RWStructuredBuffer`ï¼ˆå¯å†™ï¼‰   | âœ… å»ºè®®å¯¹é½   | Shader ä¸­å†™å…¥ç»“æ„ä½“æ•°æ®               |

å¸¸è§å¯¹é½ç­–ç•¥ï¼š

| å˜é‡ç±»å‹               | å ç”¨ç©ºé—´ï¼ˆHLSLï¼‰ | è¡¥é½å»ºè®®ï¼ˆC++ï¼‰             |
| ---------------------- | ---------------- | --------------------------- |
| `float`, `int`, `uint` | 4 å­—èŠ‚           | è¡¥ 12 å­—èŠ‚ â†’ æˆ 16 å­—èŠ‚å¯¹é½ |
| `float2`               | 8 å­—èŠ‚           | è¡¥ 8 å­—èŠ‚                   |
| `float3`               | 12 å­—èŠ‚          | è¡¥ 4 å­—èŠ‚                   |
| `float4`               | 16 å­—èŠ‚          | ä¸ç”¨è¡¥                      |
| `matrix`ï¼ˆ4x4ï¼‰        | 64 å­—èŠ‚          | å·²è‡ªåŠ¨å¯¹é½                  |

ç¤ºä¾‹ï¼š

```hlsl
cbuffer Example : register(b0)
{
    float a;     // offset 0
    float3 b;    // offset 16ï¼ˆfloat + float3 å…±äº« vec4ï¼‰
    float4 c;    // offset 32
};

```

## å‚è€ƒæ–‡æ¡£

* https://www.cnblogs.com/X-Jun/p/10262524.html